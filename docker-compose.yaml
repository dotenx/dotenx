version: '3'
services:
  scheduler_server:
    build: 
      context: ./job_scheduler/server
      dockerfile: Dockerfile
    ports:
      - '9090:9090'
    networks:
        - default
    volumes:
      - ./job_scheduler/server:/usr/src/app
      - /usr/src/app/node_modules
    environment:
      - REDIS_HOST=redis
      - AO_API_URL=http://ao-api:3004
    command: npm run dev

  ui:
    build: 
      context: ./ui
      dockerfile: Dockerfile
    ports:
      - '3010:80'
    networks:
        - default
    volumes:
      - ./ui:/usr/src/app
      - /usr/src/app/node_modules
    
  remote_worker_eg:
    build: 
      context: ./job_scheduler/remote_worker
      dockerfile: Dockerfile
    networks:
        - default
    volumes:
      - ./job_scheduler/remote_worker:/usr/src/app
      - /usr/src/app/node_modules
    environment:
      - SERVER_HOST=http://scheduler_server:9090
    command: npm run dev
  redis:
    image: redis
    hostname: redis
    ports:
      - '6380:6379'
    volumes:
      - 'redis_data:/data'

  psql:
    image: postgres:12
    hostname: postgres
    env_file:
      - postgres.env
    volumes:
      - 'postgres_data:/var/lib/postgresql/data/'
    ports:
      - '5432:5432'
    restart: unless-stopped


  ao-api:
    build:
      context: .
      dockerfile: ao-api/Dockerfile
    hostname: ao-api
    working_dir: /root/
    volumes:
     - ao_api_data:/go/src/github.com/utopiops/automated-ops/ao-api
    networks:
        - default
    ports:
      - '3004:3004'

  runner:
    build:
      context: .
      dockerfile: runner/Dockerfile
    hostname: runner
    working_dir: /root/
    volumes:
     - runner_data:/go/src/github.com/utopiops/automated-ops/runner
    networks:
        - default

networks:
  default:
    external:
      name: local

volumes:
  redis_data:
  postgres_data:
  ao_api_data:
  runner_data:
